name: flutter-mirror-release
on:
  push:
    paths:
      - "flutter/mirror/**"
      - ".github/workflows/flutter-mirror-release.yml"
    branches:
      - "main"
jobs:
  release:
    name: Create semantic release
    runs-on: ubuntu-latest
    outputs:
      name: mirror
      build_name: com.gsmlg.mirror
      version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: 🛑 Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.9.1
        with:
          access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: ⬇️ Checkout repo
        uses: actions/checkout@v2

      - name: 🚀 Release
        uses: gsmlg/semantic-release-action@v3
        id: semantic
        with:
          release_name: mirror
          working-directory: 'flutter/mirror'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      # - run: test -z "${{ steps.semantic.outputs.new_release_version }}" && exit 1 || exit 0

  build-web:
    runs-on: ubuntu-latest
    name: Build web
    needs: [ release ]
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v2

      - name: 🛤 Setup Java
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: 🚀 Setup Flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.5.3'
          channel: 'stable'

      - name: 🐳 Install dependencies
        run: |
          cd flutter/mirror
          flutter pub get

      - name: 🕸 Build Web
        run: |
          cd flutter/mirror
          flutter build web

      - name: Create package file
        run : tar zcf mirror.web.tar.gz -C flutter/mirror/build web

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mirror.web.tar.gz
          asset_name: mirror.web.tar.gz
          tag: mirror-v${{ steps.semantic.outputs.new_release_version }}
          overwrite: true

  build-linux:
    runs-on: ubuntu-latest
    name: Build Linux
    needs: [ release ]
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v2

      - name: 🛤 Setup Java
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: 🚀 Setup Flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.5.3'
          channel: 'stable'

      - name: Enable linux
        run: flutter config --enable-linux-desktop

      - name: Patch for linux build
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev

      - name: 🐳 Install dependencies
        run: |
          cd flutter/mirror
          flutter pub get

      - name: 🕸 Build Linux
        run: |
          cd flutter/mirror
          flutter build linux

      - run: find flutter/mirror/build -print
      - name: Create package file
        run : tar zcf mirror.linux.tar.gz -C flutter/mirror/build/linux/x64/release bundle

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mirror.linux.tar.gz
          asset_name: mirror.linux.tar.gz
          tag: mirror-v${{ steps.semantic.outputs.new_release_version }}
          overwrite: true

  build-apk:
    runs-on: ubuntu-latest
    name: Build apk
    needs: [ release ]
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v2

      - name: 🛤 Setup Java
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: 🚀 Setup Flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.5.3'
          channel: 'stable'

      - name: 🐳 Install dependencies
        run: |
          cd flutter/mirror
          flutter pub get

      - name: 🕸 Build APK
        run: |
          cd flutter/mirror
          flutter build apk

      - name: Create package file
        run : tar zcf mirror.android.tar.gz -C flutter/mirror/build/app/outputs/flutter-apk/ app.apk

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mirror.android.tar.gz
          asset_name: mirror.android.tar.gz
          tag: mirror-v${{ steps.semantic.outputs.new_release_version }}
          overwrite: true

  build-ios:
    runs-on: macos-latest
    name: Build ios
    needs: [ release ]
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v2

      - name: 🛤 Setup Java
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: 🚀 Setup Flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.5.3'
          channel: 'stable'

      - name: 🐳 Install dependencies
        run: |
          cd flutter/mirror
          flutter pub get

      - name: 🕸 Build iOS
        run: |
          cd flutter/mirror
          flutter build ios --no-codesign

      - run: find flutter/mirror
      - name: Create package file
        run : tar zcf mirror.ios.tar.gz -C flutter/mirror/build/ios/iphoneos/ Runner.app

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mirror.ios.tar.gz
          asset_name: mirror.ios.tar.gz
          tag: mirror-v${{ steps.semantic.outputs.new_release_version }}
          overwrite: true

  build-macos:
    runs-on: macos-latest
    name: Build macOS
    needs: [ release ]
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v2

      - name: 🛤 Setup Java
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: 🚀 Setup Flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.5.3'
          channel: 'stable'

      - name: Enable windows
        run: flutter config --enable-macos-desktop

      - name: 🐳 Install dependencies
        run: |
          cd flutter/mirror
          flutter pub get

      - name: 🕸 Build macOS
        run: |
          cd flutter/mirror
          flutter build macos

      - run: find flutter/mirror
      - name: Create package file
        run : tar zcf mirror.macos.tar.gz -C flutter/mirror/build/macos/Build/Products/Release/ mirror.app

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mirror.macos.tar.gz
          asset_name: mirror.macos.tar.gz
          tag: mirror-v${{ steps.semantic.outputs.new_release_version }}
          overwrite: true

  build-windows:
    runs-on: windows-latest
    name: Build windows
    needs: [ release ]
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v2

      - name: 🛤 Setup Java
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: 🚀 Setup Flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.5.3'
          channel: 'stable'

      - name: Enable windows
        run: flutter config --enable-windows-desktop

      - name: 🐳 Install dependencies
        run: |
          cd flutter/mirror
          flutter pub get

      - name: 🕸 Build Windows
        run: |
          cd flutter/mirror
          flutter build windows

      - run: dir flutter /S
      - name: Create package file
        run : tar zcf mirror.windows.tar.gz -C flutter\\mirror\\build\\windows\\x64\\Release Runner

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mirror.windows.tar.gz
          asset_name: mirror.windows.tar.gz
          tag: mirror-v${{ steps.semantic.outputs.new_release_version }}
          overwrite: true
